name: ğŸš¨ Hotfix

on:
  workflow_call:
    secrets:
      SLACK_BOT_TOKEN:
        required: true
      SLACK_HOTFIX_NOTIFICATION_CHANNEL:
        required: true

concurrency:
  group: hotfix-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  revoke:
    name: Revoke the review
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'unlabeled' && github.event.label.name == 'hotfix ğŸš¨' }}
    steps:
      - name: Revoke pull request
        uses: Ana06/automatic-pull-request-review@v0.1.0
        with:
          repo-token: ${{ github.token }}
          event: DISMISS

      - name: Notification
        uses: slackapi/slack-github-action@v1.16.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
          channel-id: ${{ secrets.SLACK_HOTFIX_NOTIFICATION_CHANNEL }}
          payload: |
            {
            	"blocks": [
            		{
            			"type": "section",
            			"text": {
            				"type": "mrkdwn",
            				"text": "*ğŸ§¯ í•«í”½ìŠ¤ ë¦¬ë·°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.*"
            			}
            		},
            		{
            			"type": "section",
            			"fields": [
                            {
                            	"type": "mrkdwn",
                            	"text": "> *PR Title:*\n> ${{ github.event.pull_request.title }}"
                            },
            				{
            					"type": "mrkdwn",
            					"text": "> *PR:*\n> ${{ github.event.pull_request.number }}"
            				},
            				{
            					"type": "mrkdwn",
            					"text": "> *Repository:*\n> ${{ github.repository }}"
            				}
            			]
            		},
            		{
            			"type": "actions",
            			"block_id": "actionblock789",
            			"elements": [
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"text": "ğŸ“„ PRë¡œ ë°”ë¡œê°€ê¸°"
            					},
            					"url": "${{ format('{0}/{1}/pull/{2}', github.server_url, github.repository, github.event.pull_request.number) }}"
            				},
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"text": "ğŸ•µï¸â€ ë³€ê²½ íŒŒì¼ ë°”ë¡œë³´ê¸°"
            					},
            					"style": "danger",
            					"url": "${{ format('{0}/{1}/pull/{2}/files', github.server_url, github.repository, github.event.pull_request.number) }}"
            				}
            			]
            		},
            		{
            			"type": "context",
            			"elements": [
            				{
            					"type": "mrkdwn",
            					"text": "*${{ github.actor }}* ë‹˜ì´ í•´ë‹¹ PRì„ ì‘ì—…í•˜ì…¨ìŠµë‹ˆë‹¤."
            				}
            			]
            		}
            	]
            }

  approve:
    name: Approve the PR
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.pull_request.labels.*.name, 'hotfix ğŸš¨') }}
    steps:
      - name: Approve pull request
        uses: Ana06/automatic-pull-request-review@v0.1.0
        with:
          repo-token: ${{ github.token }}
          event: APPROVE

      - name: Notification
        uses: slackapi/slack-github-action@v1.16.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
          channel-id: ${{ secrets.SLACK_HOTFIX_NOTIFICATION_CHANNEL }}
          payload: |
            {
            	"blocks": [
            		{
            			"type": "section",
            			"text": {
            				"type": "mrkdwn",
            				"text": "*ğŸš¨ í•«í”½ìŠ¤ ë¦¬ë·°(Fast-track)ê°€ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!*\n_@channel ë¦¬ë·° ë‹´ë‹¹ìëŠ” ì´ Pull requestê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤._"
            			}
            		},
            		{
            			"type": "section",
            			"fields": [
                            {
                                "type": "mrkdwn",
                                "text": "> *PR Title:*\n> ${{ github.event.pull_request.title }}"
                            },
                            {
                                "type": "mrkdwn",
                                "text": "> *PR:*\n> ${{ github.event.pull_request.number }}"
                            },
                            {
                                "type": "mrkdwn",
                                "text": "> *Repository:*\n> ${{ github.repository }}"
                            }
            			]
            		},
            		{
            			"type": "actions",
            			"block_id": "actionblock789",
            			"elements": [
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"text": "ğŸ“„ PRë¡œ ë°”ë¡œê°€ê¸°"
            					},
            					"url": "${{ format('{0}/{1}/pull/{2}', github.server_url, github.repository, github.event.pull_request.number) }}"
            				},
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"text": "ğŸ•µï¸â€ ë³€ê²½ íŒŒì¼ ë°”ë¡œë³´ê¸°"
            					},
            					"style": "danger",
            					"url": "${{ format('{0}/{1}/pull/{2}/files', github.server_url, github.repository, github.event.pull_request.number) }}"
            				}
            			]
            		},
            		{
            			"type": "context",
            			"elements": [
            				{
            					"type": "mrkdwn",
            					"text": "*${{ github.actor }}* ë‹˜ì´ í•´ë‹¹ PRì„ ì‘ì—…í•˜ì…¨ìŠµë‹ˆë‹¤."
            				}
            			]
            		}
            	]
            }
