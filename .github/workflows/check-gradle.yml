name: ‚úÖ Check Gradle (Test, Coverage, Lint)

on:
  workflow_call:
    inputs:
      java_version:
        type: string
        description: 'Java version (default is 11)'
        default: '11'
        required: false
      java_distribution:
        type: string
        description: 'Java distribution (default is adopt)'
        default: 'adopt'
        required: false
      test_commands:
        type: string
        description: 'Gradle test command. split by ","'
        default: 'test'
        required: true
      build_exclude_commands:
        type: string
        description: 'Build exclude commands. default is -x test'
        default: '-x test'
        required: false
      clean_build:
        type: boolean
        description: 'Build after clean'
        default: true
        required: false
      codecov_report:
        type: string
        description: 'Codecov.io report xml path (jacoco)'
        default: 'build/reports/jacoco/report.xml'
        required: false
      codecov_env:
        type: string
        description: 'Codecov.io environment (phase)'
        default: 'test'
        required: false
    secrets:
      AWS_ROLE_REGION:
        required: true
      AWS_CODE_MANAGER_ROLE:
        required: true
      AWS_ROLE_SESSION_DURATION:
        required: true
      AWS_CODEARTIFACT_REGION:
        required: true
      AWS_CODEARTIFACT_DOMAIN:
        required: true
      AWS_CODEARTIFACT_OWNER:
        required: true
      CODECOV_REPO_TOKEN:
        required: true
      SLACK_BOT_TOKEN:
        required: true
      SLACK_REVIEW_NOTIFICATION_CHANNEL:
        required: true

env:
  JAVA_VERSION: ${{ inputs.java_version == null && '11' || inputs.java_version }}
  JAVA_DISTRIBUTION: ${{ inputs.java_distribution == null && 'adopt' || inputs.java_distribution }}
  CLEAN_BUILD: ${{ inputs.clean_build == null && true || inputs.clean_build }}
  CODECOV_REPORT: ${{ inputs.codecov_report == null && 'build/reports/jacoco/report.xml' || inputs.codecov_report }}
  CODECOV_ENV: ${{ inputs.codecov_env == null && 'test' || inputs.codecov_env }}

concurrency:
  group: check-${{ github.repository }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  Matrix:
    name: 'Matrix'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extract.outputs.result }}
    steps:
      - name: Extract
        uses: actions/github-script@v5
        id: extract
        env:
          MATRIX: ${{ inputs.test_commands }}
        with:
          result-encoding: string
          script: |
            const { MATRIX } = process.env;

            console.log(`${MATRIX} <- Input`);

            if (MATRIX == null || MATRIX == '') {
              throw Error('Undefined matrix');
            }

            return JSON.stringify({
              item: MATRIX.split(',').map(item => item.trim())
            })
      - name: Output
        run: |
          echo "${{ steps.extract.outputs.result }}"

  Tests:
    name: 'Tests'
    if: ${{ github.event_name != 'pull_request' || (github.event_name == 'pull_request' && github.event.action != 'unlabeled' && !contains(github.event.pull_request.labels.*.name, 'hotfix üö®')) || (github.event_name == 'pull_request' && github.event.action == 'unlabeled' && github.event.label.name == 'hotfix üö®') }}
    needs:
      - Matrix
    strategy:
      matrix:
        gradle: ${{ fromJson(needs.Matrix.outputs.matrix).item }}
    runs-on: actions-runner-system
    timeout-minutes: 16
    outputs:
      status: ${{ job.status }}
      clean_result: ${{ steps.clean.outputs.CLEAN_RESULT }}
      build_result: ${{ steps.build.outputs.BUILD_RESULT }}
      test_result: ${{ steps.test.outputs.TEST_RESULT }}
    steps:
      - name: Find Comment
        uses: peter-evans/find-comment@v1
        id: fc
        if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix üö®') }}
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle }}'
          direction: last

      - name: Create PR Comment
        if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix üö®') && steps.fc.outputs.comment-id == '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### üèÉ ÌÖåÏä§Ìä∏ `${{ matrix.gradle }}` Î•º ÏßÑÌñâÏ§ëÏûÖÎãàÎã§!
            ÏßÄÍ∏à `PR-${{ github.event.pull_request.number }}` Ïóê ÎåÄÌï¥ ÌÖåÏä§Ìä∏Î•º ÏßÑÌñâÌïòÍ≥† ÏûàÏäµÎãàÎã§. Ï°∞Í∏àÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî!
            ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÎäî PR Comment, Slack ÏúºÎ°ú ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle }}

      - name: Update PR Comment
        if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix üö®') && steps.fc.outputs.comment-id != '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### üèÉ Îã§Ïãú ÌÖåÏä§Ìä∏ `${{ matrix.gradle }}` Î•º ÏßÑÌñâÏ§ëÏûÖÎãàÎã§! üòß
            ÏßÄÍ∏à `PR-${{ github.event.pull_request.number}}` Ïóê ÎåÄÌï¥ ÌÖåÏä§Ìä∏Î•º ÏßÑÌñâÌïòÍ≥† ÏûàÏäµÎãàÎã§. Ï°∞Í∏àÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî!
            ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÎäî PR Comment, Slack ÏúºÎ°ú ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle }}

      - name: Checkout Pull Request VCS
        uses: actions/checkout@v2
        if: ${{ github.event_name == 'pull_request' }}
        with:
          token: ${{ github.token }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Checkout VCS (Non PR)
        uses: actions/checkout@v2
        if: ${{ github.event_name != 'pull_request' }}
        with:
          token: ${{ github.token }}
          ref: ${{ github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          architecture: x64
          cache: gradle

      - name: Cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: AWS AssumeRole (Auth)
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_ROLE_REGION }}
          role-to-assume: ${{ secrets.AWS_CODE_MANAGER_ROLE }}
          role-duration-seconds: ${{ secrets.AWS_ROLE_SESSION_DURATION }}

      - name: AWS CodeArtifact Authentication (Gradle)
        uses: dshare-inc/actions-codeartifact-auth@1.0.1
        with:
          region: ${{ secrets.AWS_CODEARTIFACT_REGION }}
          domain: ${{ secrets.AWS_CODEARTIFACT_DOMAIN }}
          owner: ${{ secrets.AWS_CODEARTIFACT_OWNER }}
          type: gradle
          repo: gradle

      - name: Clean
        if: ${{ env.CLEAN_BUILD == 'true' }}
        id: clean
        run: |
          CLEAN_RESULT="$(./gradlew --console verbose clean -Dconsole.encoding=UTF-8 -Dfile.encoding=UTF-8 --no-daemon --parallel)"
          echo "$CLEAN_RESULT"

          CLEAN_RESULT="${CLEAN_RESULT//'%'/'%25'}"
          CLEAN_RESULT="${CLEAN_RESULT//$'\n'/'%0A'}"
          CLEAN_RESULT="${CLEAN_RESULT//$'\r'/'%0D'}"
          CLEAN_RESULT="$(echo $CLEAN_RESULT | sed 's/\x1B\[[0-9;]\+[A-Za-z]//g')"
          echo "::set-output name=CLEAN_RESULT::$(echo $CLEAN_RESULT)"

      - name: Build
        id: build
        run: |
          BUILD_RESULT="$(./gradlew --console verbose build ${{ inputs.build_exclude_commands }} -Dconsole.encoding=UTF-8 -Dfile.encoding=UTF-8 --no-daemon --parallel)"
          echo "$BUILD_RESULT"

          BUILD_RESULT="${BUILD_RESULT//'%'/'%25'}"
          BUILD_RESULT="${BUILD_RESULT//$'\n'/'%0A'}"
          BUILD_RESULT="${BUILD_RESULT//$'\r'/'%0D'}"
          BUILD_RESULT="$(echo $BUILD_RESULT | sed 's/\x1B\[[0-9;]\+[A-Za-z]//g')"
          echo "::set-output name=BUILD_RESULT::$(echo $BUILD_RESULT)"

      - name: Tests
        if: ${{ always() }}
        id: test
        run: |
          TEST_RESULT="$(./gradlew --console verbose ${{ matrix.gradle }} jacocoTestReport -Dconsole.encoding=UTF-8 -Dfile.encoding=UTF-8 --no-daemon --parallel)"
          echo "$TEST_RESULT"

          TEST_RESULT="${TEST_RESULT//'%'/'%25'}"
          TEST_RESULT="${TEST_RESULT//$'\n'/'%0A'}"
          TEST_RESULT="${TEST_RESULT//$'\r'/'%0D'}"
          TEST_RESULT="$(echo $TEST_RESULT | sed 's/\x1B\[[0-9;]\+[A-Za-z]//g')"
          echo "::set-output name=TEST_RESULT::$(echo $TEST_RESULT)"

      - name: Add Code Coverage Report
        uses: codecov/codecov-action@v1
        if: ${{ always() }}
        with:
          token: ${{ secrets.CODECOV_REPO_TOKEN }}
          flags: ${{ matrix.gradle }}
          fail_ci_if_error: false
          verbose: false
          env_vars: ${{ env.CODECOV_ENV }}
          files: ${{ env.CODECOV_REPORT }}

      - name: Succeed (Create PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.result == 'success' && steps.fc.outputs.comment-id == '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ‚úÖ ÌÖåÏä§Ìä∏ `${{ matrix.gradle }}` Ïóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§!
            **üéâ ÌòÑÏû¨ ÏãúÏä§ÌÖúÏùò ÌÖåÏä§Ìä∏Í∞Ä Î™®Îëê ÌÜµÍ≥ºÌïòÏòÄÏäµÎãàÎã§.** ÏûêÏÑ∏Ìïú ÎÇ¥Ïó≠ÏùÄ Action Ïùò `Details` Î≤ÑÌäºÏùÑ ÎàÑÎ•∏ ÌõÑ ÌôïÏù∏ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.

            ### üßπ Clean
            ```
            ${{ steps.test.outputs.clean_result }}
            ```

            ### üíæ Build
            ```
            ${{ steps.test.outputs.build_result }}
            ```

            ### ü§ñ Tests
            ```
            ${{ steps.test.outputs.test_result }}
            ```

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle }}

      - name: Succeed (Update PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.result == 'success' && steps.fc.outputs.comment-id != '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### ‚úÖ ÌÖåÏä§Ìä∏ `${{ matrix.gradle }}` Ïóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§!
            **üéâ ÌòÑÏû¨ ÏãúÏä§ÌÖúÏùò ÌÖåÏä§Ìä∏Í∞Ä Î™®Îëê ÌÜµÍ≥ºÌïòÏòÄÏäµÎãàÎã§.** ÏûêÏÑ∏Ìïú ÎÇ¥Ïó≠ÏùÄ Action Ïùò `Details` Î≤ÑÌäºÏùÑ ÎàÑÎ•∏ ÌõÑ ÌôïÏù∏ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.

            ### üßπ Clean
            ```
            ${{ steps.test.outputs.clean_result }}
            ```

            ### üíæ Build
            ```
            ${{ steps.test.outputs.build_result }}
            ```

            ### ü§ñ Tests
            ```
            ${{ steps.test.outputs.test_result }}
            ```

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle }}

      - name: Failed (Create PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.result == 'failure' && steps.fc.outputs.comment-id == '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ‚ùå ÌÖåÏä§Ìä∏Ïóê `${{ matrix.gradle }}` Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§!
            ÌòÑÏû¨ ÏãúÏä§ÌÖúÏùò ÌÖåÏä§Ìä∏Í∞Ä Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§. ÏïÑÎûò ActionÏùò `Details` Î•º ÌôïÏù∏ÌïòÏãúÍ±∞ÎÇò, CommentÎ•º ÌÜµÌï¥ Ï†úÍ≥µÎêú Console LogÎ•º Ï∞∏Í≥†ÌïòÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.

            ### üßπ Clean
            ```
            ${{ steps.test.outputs.clean_result }}
            ```

            ### üíæ Build
            ```
            ${{ steps.test.outputs.build_result }}
            ```

            ### ü§ñ Tests
            ```
            ${{ steps.test.outputs.test_result }}
            ```

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle }}

      - name: Failed (Update PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.result == 'failure' && steps.fc.outputs.comment-id != '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### ‚ùå ÌÖåÏä§Ìä∏Ïóê `${{ matrix.gradle }}` Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§!
            ÌòÑÏû¨ ÏãúÏä§ÌÖúÏùò ÌÖåÏä§Ìä∏Í∞Ä Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§. ÏïÑÎûò ActionÏùò `Details` Î•º ÌôïÏù∏ÌïòÏãúÍ±∞ÎÇò, CommentÎ•º ÌÜµÌï¥ Ï†úÍ≥µÎêú Console LogÎ•º Ï∞∏Í≥†ÌïòÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.

            ### üßπ Clean
            ```
            ${{ steps.test.outputs.clean_result }}
            ```

            ### üíæ Build
            ```
            ${{ steps.test.outputs.build_result }}
            ```

            ### ü§ñ Tests
            ```
            ${{ steps.test.outputs.test_result }}
            ```

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle }}

  NotifyResult:
    needs:
      - Tests
    if: ${{ github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix üö®')) }}
    name: 'Notification (Result)'
    runs-on: ubuntu-latest
    steps:
      - name: Succeed (Slack PR)
        uses: slackapi/slack-github-action@v1.16.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
          channel-id: ${{ secrets.SLACK_REVIEW_NOTIFICATION_CHANNEL }}
          payload: |
            {
            	"blocks": [
            		{
            			"type": "section",
            			"text": {
            				"type": "mrkdwn",
            				"text": "*${{ needs.Tests.result == 'success' && '‚úÖ ÌÖåÏä§Ìä∏ Î∞è Í≤ÄÏ¶ù ÏÑ±Í≥µ* _(SUCCESS)_' || '‚ùå ÌÖåÏä§Ìä∏ Î∞è Í≤ÄÏ¶ù Ïã§Ìå®* _(FAILURE)' }}\n_Î∏åÎûúÏπò ÎòêÎäî Pull request Í≤ÄÏ¶ù(ÌÖåÏä§Ìä∏, Lint, Code coverage)Ïóê ÏÑ±Í≥µÌïòÏòÄÏäµÎãàÎã§._"
            			}
            		},
            		{
            			"type": "section",
            			"fields": [
            				{
            					"type": "mrkdwn",
            					"text": "> *Repository:*\n> ${{ github.repository }}"
            				},
            				{
            					"type": "mrkdwn",
            					"text": "> *${{ github.event_name == 'pull_request' && 'PR Number' || 'Branch' }}:*\n> ${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}"
            				},
            				{
            					"type": "mrkdwn",
            					"text": "> *${{ github.event_name == 'pull_request' && 'PR Title' || 'Commit' }}:*\n> ${{ github.event_name == 'pull_request' && github.event.pull_request.title || github.sha }}"
            				}
            			]
            		},
            		{
            			"type": "actions",
            			"elements": [
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"emoji": true,
            						"text": "üìÑ ${{ github.event_name == 'pull_request' && 'PRÎ°ú' || 'CommitÏúºÎ°ú' }} Î∞îÎ°úÍ∞ÄÍ∏∞"
            					},
            					"value": "go_to_pr",
            					"url": "${{ github.event_name == 'pull_request' && format('{0}/{1}/pull/{2}', github.server_url, github.repository, github.event.pull_request.number) || format('{0}/{1}/commit/{2}', github.server_url, github.repository, github.sha) }}"
            				},
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"emoji": true,
            						"text": "üöÄ Action Í≤∞Í≥ºÎ°ú Î∞îÎ°úÍ∞ÄÍ∏∞"
            					},
            					"value": "go_to_action",
            					"url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            				}
            			]
            		},
            		{
            			"type": "context",
            			"elements": [
            				{
            					"type": "mrkdwn",
            					"text": "*${{ github.actor }}* ÎãòÏù¥ Ïã§Ìñâ ÎòêÎäî Ìï¥Îãπ Î∏åÎûúÏπò(PR)Î•º ÏûëÏóÖÌïòÏÖ®ÏäµÎãàÎã§."
            				}
            			]
            		}
            	]
            }
