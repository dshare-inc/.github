name: âœ… Check (Gradle)

on:
  workflow_call:
    inputs:
      java_version:
        type: string
        description: 'Java version (default is 11)'
        default: '11'
        required: false
      java_distribution:
        type: string
        description: 'Java distribution (default is adopt)'
        default: 'adopt'
        required: false
      commands:
        type: string
        description: 'Gradle test command. split by ",". build and code coverage report is @.'
        default: 'test @ jacocoTestReport @ build -x test @ build/reports/jacoco/report.xml @ test'
        required: false
      clean_build:
        type: boolean
        description: 'Build after clean'
        default: true
        required: false
      codecov_env:
        type: string
        description: 'Codecov.io environment (phase)'
        default: 'test'
        required: false
    secrets:
      AWS_ROLE_REGION:
        required: true
      AWS_CODE_MANAGER_ROLE:
        required: true
      AWS_ROLE_SESSION_DURATION:
        required: true
      AWS_CODEARTIFACT_REGION:
        required: true
      AWS_CODEARTIFACT_DOMAIN:
        required: true
      AWS_CODEARTIFACT_OWNER:
        required: true
      CODECOV_REPO_TOKEN:
        required: true
      SLACK_BOT_TOKEN:
        required: true
      SLACK_REVIEW_NOTIFICATION_CHANNEL:
        required: true

env:
  JAVA_VERSION: ${{ inputs.java_version == null && '11' || inputs.java_version }}
  JAVA_DISTRIBUTION: ${{ inputs.java_distribution == null && 'adopt' || inputs.java_distribution }}
  CLEAN_BUILD: ${{ inputs.clean_build == null && true || inputs.clean_build }}
  CODECOV_ENV: ${{ inputs.codecov_env == null && 'test' || inputs.codecov_env }}

concurrency:
  group: check-${{ github.repository }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  Matrix:
    name: 'Matrix'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extract.outputs.result }}
    steps:
      - name: Extract
        uses: actions/github-script@v5
        id: extract
        env:
          MATRIX: ${{ inputs.commands }}
        with:
          result-encoding: string
          script: |
            const { MATRIX } = process.env;

            console.log(`${MATRIX} <- Input`);

            if (MATRIX == null || MATRIX == '') {
              throw Error('Undefined matrix');
            }

            return JSON.stringify({ item: MATRIX.split(',')
              .map(item => item.trim())
              .map(item => {
                const result = item.split('@');
                return {
                  test: result[0].trim(),
                  result: result[1].trim(),
                  build: result[2].trim(),
                  report: result[3].trim(),
                  name: result[4].trim()
                };
              })
            });

  Tests:
    name: 'Tests (${{ matrix.gradle.name }})'
    if: ${{ github.event_name != 'pull_request' || (github.event_name == 'pull_request' && github.event.action != 'unlabeled' && !contains(github.event.pull_request.labels.*.name, 'hotfix ğŸš¨')) || (github.event_name == 'pull_request' && github.event.action == 'unlabeled' && github.event.label.name == 'hotfix ğŸš¨') }}
    needs:
      - Matrix
    strategy:
      matrix:
        gradle: ${{ fromJson(needs.Matrix.outputs.matrix).item }}
    runs-on: actions-runner-system
    timeout-minutes: 16
    outputs:
      status: ${{ job.status }}
    steps:
      - name: Find Comment
        uses: peter-evans/find-comment@v1
        id: fc
        if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix ğŸš¨') }}
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}'
          direction: last

      - name: Create PR Comment
        if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix ğŸš¨') && steps.fc.outputs.comment-id == '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ğŸƒ í…ŒìŠ¤íŠ¸ `${{ matrix.gradle.name }}` ë¥¼ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤!
            ì§€ê¸ˆ `PR-${{ github.event.pull_request.number }}` ì— ëŒ€í•´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
            í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” PR Comment, Slack ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}

      - name: Update PR Comment
        if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix ğŸš¨') && steps.fc.outputs.comment-id != '' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### ğŸƒ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ `${{ matrix.gradle.name }}` ë¥¼ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤! ğŸ˜§
            ì§€ê¸ˆ `PR-${{ github.event.pull_request.number}}` ì— ëŒ€í•´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
            í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” PR Comment, Slack ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}

      - name: Checkout Pull Request VCS
        uses: actions/checkout@v2
        if: ${{ github.event_name == 'pull_request' }}
        with:
          token: ${{ github.token }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Checkout VCS (Non PR)
        uses: actions/checkout@v2
        if: ${{ github.event_name != 'pull_request' }}
        with:
          token: ${{ github.token }}
          ref: ${{ github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          architecture: x64
          cache: gradle

      - name: Cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: AWS AssumeRole (Auth)
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_ROLE_REGION }}
          role-to-assume: ${{ secrets.AWS_CODE_MANAGER_ROLE }}
          role-duration-seconds: ${{ secrets.AWS_ROLE_SESSION_DURATION }}

      - name: AWS CodeArtifact Authentication (Gradle)
        uses: dshare-inc/actions-codeartifact-auth@1.0.1
        with:
          region: ${{ secrets.AWS_CODEARTIFACT_REGION }}
          domain: ${{ secrets.AWS_CODEARTIFACT_DOMAIN }}
          owner: ${{ secrets.AWS_CODEARTIFACT_OWNER }}
          type: gradle
          repo: gradle

      - name: Clean
        if: ${{ env.CLEAN_BUILD == 'true' }}
        id: clean
        run: |
          CLEAN_RESULT="$(./gradlew --console verbose clean -Dconsole.encoding=UTF-8 -Dfile.encoding=UTF-8 --no-daemon --parallel)"
          echo "$CLEAN_RESULT"

          CLEAN_RESULT="${CLEAN_RESULT//'%'/'%25'}"
          CLEAN_RESULT="${CLEAN_RESULT//$'\n'/'%0A'}"
          CLEAN_RESULT="${CLEAN_RESULT//$'\r'/'%0D'}"
          CLEAN_RESULT="$(echo $CLEAN_RESULT | sed 's/\x1B\[[0-9;]\+[A-Za-z]//g')"
          echo "::set-output name=clean_result::$(echo $CLEAN_RESULT)"

      - name: Build
        id: build
        run: |
          BUILD_RESULT="$(./gradlew --console verbose ${{ matrix.gradle.build }} -Dconsole.encoding=UTF-8 -Dfile.encoding=UTF-8 --no-daemon --parallel)"
          echo "$BUILD_RESULT"

          BUILD_RESULT="${BUILD_RESULT//'%'/'%25'}"
          BUILD_RESULT="${BUILD_RESULT//$'\n'/'%0A'}"
          BUILD_RESULT="${BUILD_RESULT//$'\r'/'%0D'}"
          BUILD_RESULT="$(echo $BUILD_RESULT | sed 's/\x1B\[[0-9;]\+[A-Za-z]//g')"
          echo "::set-output name=build_result::$(echo $BUILD_RESULT)"

      - name: Tests
        id: test
        run: |
          TEST_RESULT="$(./gradlew --console verbose ${{ matrix.gradle.test }} -Dconsole.encoding=UTF-8 -Dfile.encoding=UTF-8 --no-daemon --parallel)"
          echo "$TEST_RESULT"

          TEST_RESULT="${TEST_RESULT//'%'/'%25'}"
          TEST_RESULT="${TEST_RESULT//$'\n'/'%0A'}"
          TEST_RESULT="${TEST_RESULT//$'\r'/'%0D'}"
          TEST_RESULT="$(echo $TEST_RESULT | sed 's/\x1B\[[0-9;]\+[A-Za-z]//g')"
          echo "::set-output name=test_result::$(echo $TEST_RESULT)"

      - name: Generate report
        if: ${{ always() }}
        run: |
          ./gradlew --console verbose ${{ matrix.gradle.result }} -Dconsole.encoding=UTF-8 -Dfile.encoding=UTF-8 --no-daemon --parallel)

      - name: Change report name
        if: ${{ always() }}
        run: |
          cp ${{ matrix.gradle.report }} ./code-coverage-test-report.xml

      - name: Upload code coverage report
        uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: ${{ matrix.gradle.name }}-report
          path: code-coverage-test-report.xml
          retention-days: 7
          if-no-files-found: error

      - name: Find Comment (After)
        uses: peter-evans/find-comment@v1
        id: fc_after
        if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix ğŸš¨') }}
        continue-on-error: true
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}'
          direction: last

      - name: Succeed (Create PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.outcome == 'success' && steps.fc_after.outputs.comment-id == '' }}
        continue-on-error: true
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### âœ… í…ŒìŠ¤íŠ¸ `${{ matrix.gradle.name }}` ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!
            **ğŸ‰ í˜„ì¬ ì‹œìŠ¤í…œì˜ í…ŒìŠ¤íŠ¸ê°€ ëª¨ë‘ í†µê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.** ìì„¸í•œ ë‚´ì—­ì€ Action ì˜ `Details` ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}

      - name: Succeed (Update PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.outcome == 'success' && steps.fc_after.outputs.comment-id != '' }}
        continue-on-error: true
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc_after.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### âœ… í…ŒìŠ¤íŠ¸ `${{ matrix.gradle.name }}` ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!
            **ğŸ‰ í˜„ì¬ ì‹œìŠ¤í…œì˜ í…ŒìŠ¤íŠ¸ê°€ ëª¨ë‘ í†µê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.** ìì„¸í•œ ë‚´ì—­ì€ Action ì˜ `Details` ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}

      - name: Failed (Create PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.outcome != 'success' && steps.fc_after.outputs.comment-id == '' }}
        continue-on-error: true
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### âŒ í…ŒìŠ¤íŠ¸ì— `${{ matrix.gradle.name }}` ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤!
            í˜„ì¬ ì‹œìŠ¤í…œì˜ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì•„ë˜ Actionì˜ `Details` ë¥¼ í™•ì¸í•˜ì‹œê±°ë‚˜, Commentë¥¼ í†µí•´ ì œê³µëœ Console Logë¥¼ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

            ### ğŸ’¾ Build
            ```
            ${{ steps.build.outputs.build_result }}
            ```

            ### ğŸ¤– Tests
            ```
            ${{ steps.test.outputs.test_result }}
            ```

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}

      - name: Failed (Update PR Comment)
        if: ${{ github.event_name == 'pull_request' && steps.test.outcome != 'success' && steps.fc_after.outputs.comment-id != '' }}
        continue-on-error: true
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc_after.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### âŒ í…ŒìŠ¤íŠ¸ì— `${{ matrix.gradle.name }}` ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤!
            í˜„ì¬ ì‹œìŠ¤í…œì˜ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì•„ë˜ Actionì˜ `Details` ë¥¼ í™•ì¸í•˜ì‹œê±°ë‚˜, Commentë¥¼ í†µí•´ ì œê³µëœ Console Logë¥¼ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

            ### ğŸ’¾ Build
            ```
            ${{ steps.build.outputs.build_result }}
            ```

            ### ğŸ¤– Tests
            ```
            ${{ steps.test.outputs.test_result }}
            ```

            by dshare-bot, PR COMMENT (check-gradle) ${{ matrix.gradle.name }}

  Codecov:
    name: Add report (Codecov.io)
    runs-on: ubuntu-latest
    needs:
      - Tests
    if: ${{ always() }}
    steps:
      - name: Download files
        uses: actions/download-artifact@v2

      - name: Show files
        run: |
          ls -la

      - name: Add Code coverage reports
        uses: codecov/codecov-action@v2
        if: ${{ always() }}
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_REPO_TOKEN }}
          files: '*-report/code-coverage-test-report.xml'
          fail_ci_if_error: false

  NotifyResult:
    needs:
      - Tests
    if: ${{ github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'hotfix ğŸš¨')) }}
    name: 'Notification (Result)'
    runs-on: ubuntu-latest
    steps:
      - name: Succeed (Slack PR)
        uses: slackapi/slack-github-action@v1.16.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
          channel-id: ${{ secrets.SLACK_REVIEW_NOTIFICATION_CHANNEL }}
          payload: |
            {
            	"blocks": [
            		{
            			"type": "section",
            			"text": {
            				"type": "mrkdwn",
            				"text": "*${{ needs.Tests.result == 'success' && 'âœ… í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ì„±ê³µ* _(SUCCESS)_' || 'âŒ í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ì‹¤íŒ¨* _(FAILURE)' }}\n_ë¸Œëœì¹˜ ë˜ëŠ” Pull request ê²€ì¦(í…ŒìŠ¤íŠ¸, Lint, Code coverage)ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤._"
            			}
            		},
            		{
            			"type": "section",
            			"fields": [
                            {
                            	"type": "mrkdwn",
                            	"text": "> *${{ github.event_name == 'pull_request' && 'PR Title' || 'Commit' }}:*\n> ${{ github.event_name == 'pull_request' && github.event.pull_request.title || github.sha }}"
                            },
            				{
            					"type": "mrkdwn",
            					"text": "> *Repository:*\n> ${{ github.repository }}"
            				},
            				{
            					"type": "mrkdwn",
            					"text": "> *${{ github.event_name == 'pull_request' && 'PR Number' || 'Branch' }}:*\n> ${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}"
            				}
            			]
            		},
            		{
            			"type": "actions",
            			"elements": [
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"emoji": true,
            						"text": "ğŸ“„ ${{ github.event_name == 'pull_request' && 'PRë¡œ' || 'Commitìœ¼ë¡œ' }} ë°”ë¡œê°€ê¸°"
            					},
            					"url": "${{ github.event_name == 'pull_request' && format('{0}/{1}/pull/{2}', github.server_url, github.repository, github.event.pull_request.number) || format('{0}/{1}/commit/{2}', github.server_url, github.repository, github.sha) }}"
            				},
            				{
            					"type": "button",
            					"text": {
            						"type": "plain_text",
            						"emoji": true,
            						"text": "ğŸš€ Action ê²°ê³¼ë¡œ ë°”ë¡œê°€ê¸°"
            					},
            					"url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            				}
            			]
            		},
            		{
            			"type": "context",
            			"elements": [
            				{
            					"type": "mrkdwn",
            					"text": "*${{ github.actor }}* ë‹˜ì´ ì‹¤í–‰ ë˜ëŠ” í•´ë‹¹ ë¸Œëœì¹˜(PR)ë¥¼ ì‘ì—…í•˜ì…¨ìŠµë‹ˆë‹¤."
            				}
            			]
            		}
            	]
            }
